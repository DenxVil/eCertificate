{% extends "base.html" %}

{% block title %}Smart Certificate Generator - Goonj{% endblock %}

{% block extra_css %}
<style>
    .workflow-steps {
        display: flex;
        justify-content: space-between;
        margin-bottom: 2rem;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 10px;
    }
    
    .step {
        flex: 1;
        text-align: center;
        padding: 1rem;
        position: relative;
    }
    
    .step::after {
        content: '‚Üí';
        position: absolute;
        right: -15px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 1.5rem;
        color: #667eea;
    }
    
    .step:last-child::after {
        content: '';
    }
    
    .step.active {
        background: #667eea;
        color: white;
        border-radius: 8px;
    }
    
    .step.completed {
        background: #28a745;
        color: white;
        border-radius: 8px;
    }
    
    .upload-area {
        border: 2px dashed #667eea;
        border-radius: 10px;
        padding: 3rem;
        text-align: center;
        background: #f8f9fa;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .upload-area:hover {
        background: #e9ecef;
        border-color: #5568d3;
    }
    
    .upload-area.dragover {
        background: #d4edda;
        border-color: #28a745;
    }
    
    .field-card {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .field-preview {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .field-info {
        flex: 1;
    }
    
    .field-label {
        font-weight: bold;
        color: #667eea;
        margin-bottom: 0.5rem;
    }
    
    .field-details {
        font-size: 0.9rem;
        color: #666;
    }
    
    .preview-image {
        max-width: 100%;
        border: 1px solid #ddd;
        border-radius: 8px;
        margin-top: 1rem;
    }
    
    .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(102, 126, 234, 0.3);
        border-radius: 50%;
        border-top-color: #667eea;
        animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<h1>üéØ Smart Certificate Generator</h1>
<p style="color: #666; margin-bottom: 2rem;">Upload your template, let AI detect fields, and generate perfectly aligned certificates</p>

<!-- Workflow Steps -->
<div class="workflow-steps">
    <div class="step" id="step1">
        <div>üìÑ</div>
        <div>Upload Template</div>
    </div>
    <div class="step" id="step2">
        <div>üîç</div>
        <div>Scan Fields</div>
    </div>
    <div class="step" id="step3">
        <div>‚úèÔ∏è</div>
        <div>Enter Values</div>
    </div>
    <div class="step" id="step4">
        <div>‚úÖ</div>
        <div>Generate</div>
    </div>
</div>

<!-- Step 1: Upload Template -->
<div id="upload-section">
    <h2>Step 1: Upload Your Certificate Template</h2>
    <form id="uploadForm" enctype="multipart/form-data">
        <div class="upload-area" id="uploadArea">
            <div style="font-size: 3rem; margin-bottom: 1rem;">üì§</div>
            <h3>Drop your certificate template here</h3>
            <p style="color: #666; margin: 1rem 0;">or click to browse</p>
            <input type="file" id="templateFile" name="template" accept="image/png,image/jpeg,image/jpg,application/pdf" style="display: none;">
            <button type="button" class="btn" onclick="document.getElementById('templateFile').click()">Choose File</button>
            <p style="font-size: 0.9rem; color: #999; margin-top: 1rem;">Supported formats: PNG, JPG, PDF</p>
        </div>
    </form>
</div>

<!-- Step 2: Scanning Results -->
<div id="scanning-section" style="display: none;">
    <h2>Step 2: Scanning Template...</h2>
    <div style="text-align: center; padding: 3rem;">
        <div class="loading" style="width: 50px; height: 50px; border-width: 5px;"></div>
        <p style="margin-top: 1rem; color: #666;">Analyzing your template and detecting text fields...</p>
    </div>
</div>

<!-- Step 3: Fields Detected -->
<div id="fields-section" style="display: none;">
    <h2>Step 3: Enter Values for Detected Fields</h2>
    <p style="color: #666; margin-bottom: 1.5rem;">We detected the following fields in your certificate. Please enter the values:</p>
    
    <div id="detectedFields">
        <!-- Fields will be dynamically added here -->
    </div>
    
    <div style="margin-top: 2rem;">
        <button type="button" class="btn" id="generateBtn">Generate Certificate</button>
    </div>
</div>

<!-- Step 4: Generated Certificate -->
<div id="result-section" style="display: none;">
    <h2>Step 4: Certificate Generated! ‚úÖ</h2>
    <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
        <p style="color: #155724; margin: 0;">‚úì Your certificate has been generated successfully!</p>
    </div>
    
    <div id="certificatePreview">
        <!-- Certificate preview will be shown here -->
    </div>
    
    <div style="margin-top: 2rem;">
        <button type="button" class="btn" id="downloadBtn">Download Certificate</button>
        <button type="button" class="btn btn-secondary" onclick="location.reload()">Generate Another</button>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let uploadedTemplate = null;
let scannedData = null;
let fieldValues = {};

// Upload area drag and drop
const uploadArea = document.getElementById('uploadArea');
const templateFile = document.getElementById('templateFile');

uploadArea.addEventListener('click', () => {
    templateFile.click();
});

uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        templateFile.files = files;
        handleFileUpload(files[0]);
    }
});

templateFile.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleFileUpload(e.target.files[0]);
    }
});

function handleFileUpload(file) {
    // Show scanning section
    setStep(2);
    document.getElementById('upload-section').style.display = 'none';
    document.getElementById('scanning-section').style.display = 'block';
    
    // Create form data
    const formData = new FormData();
    formData.append('template', file);
    
    // Upload and scan
    fetch('/smart-certificate/scan', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.error || 'Server error');
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            scannedData = data;
            displayDetectedFields(data.fields);
        } else {
            alert('Error scanning template: ' + (data.error || 'Unknown error'));
            location.reload();
        }
    })
    .catch(error => {
        alert('Error uploading template: ' + error.message);
        location.reload();
    });
}

function displayDetectedFields(fields) {
    setStep(3);
    document.getElementById('scanning-section').style.display = 'none';
    document.getElementById('fields-section').style.display = 'block';
    
    const container = document.getElementById('detectedFields');
    container.innerHTML = '';
    
    if (!fields || fields.length === 0) {
        container.innerHTML = '<p style="color: #666;">No fields detected. You can still use the template, but manual positioning may be required.</p>';
        return;
    }
    
    fields.forEach((field, index) => {
        const fieldCard = document.createElement('div');
        fieldCard.className = 'field-card';
        fieldCard.innerHTML = `
            <div class="field-label">Field ${index + 1}: "${field.text}"</div>
            <div class="field-details">
                Position: (${(field.x * 100).toFixed(1)}%, ${(field.y * 100).toFixed(1)}%) | 
                Font Size: ${field.font_size}px | 
                Alignment: ${field.alignment} |
                Type: ${field.field_type}
            </div>
            <div style="margin-top: 1rem;">
                <label for="field_${index}">Enter value for this field:</label>
                <input type="text" 
                       id="field_${index}" 
                       data-field-text="${field.text}"
                       placeholder="Enter ${field.text}" 
                       style="width: 100%; padding: 10px; margin-top: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
            </div>
        `;
        container.appendChild(fieldCard);
    });
}

document.getElementById('generateBtn').addEventListener('click', () => {
    // Collect field values
    const fields = scannedData.fields;
    fieldValues = {};
    
    fields.forEach((field, index) => {
        const input = document.getElementById(`field_${index}`);
        if (input) {
            fieldValues[field.text] = input.value || field.text;
        }
    });
    
    // Show loading state
    const generateBtn = document.getElementById('generateBtn');
    const originalBtnText = generateBtn.textContent;
    generateBtn.disabled = true;
    generateBtn.innerHTML = '<span class="loading"></span> Generating...';
    
    // Generate certificate
    fetch('/smart-certificate/generate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            template_path: scannedData.template_path,
            fields: fieldValues
        })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.error || 'Server error');
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Show step 4
            setStep(4);
            document.getElementById('fields-section').style.display = 'none';
            document.getElementById('result-section').style.display = 'block';
            displayGeneratedCertificate(data);
        } else {
            throw new Error(data.error || 'Unknown error');
        }
    })
    .catch(error => {
        alert('Error generating certificate: ' + error.message);
        generateBtn.disabled = false;
        generateBtn.textContent = originalBtnText;
    });
});

function displayGeneratedCertificate(data) {
    const preview = document.getElementById('certificatePreview');
    preview.innerHTML = `
        <img src="/${data.certificate_path}" class="preview-image" alt="Generated Certificate">
    `;
    
    document.getElementById('downloadBtn').onclick = () => {
        window.location.href = '/smart-certificate/download?path=' + encodeURIComponent(data.certificate_path);
    };
}

function setStep(stepNumber) {
    // Update step indicators
    for (let i = 1; i <= 4; i++) {
        const step = document.getElementById(`step${i}`);
        step.classList.remove('active', 'completed');
        if (i < stepNumber) {
            step.classList.add('completed');
        } else if (i === stepNumber) {
            step.classList.add('active');
        }
    }
}

// Initialize
setStep(1);
</script>
{% endblock %}
