<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GOONJ Certificate | AMA</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/goonj.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/system_status.css') }}">
</head>
<body>
  <!-- Theme Toggle Button -->
  <button class="theme-toggle" id="theme-toggle" aria-label="Toggle dark mode" title="Toggle theme">
    <span id="theme-icon">üåô</span>
  </button>

  <header class="site-header">
    <div class="container header-inner">
      <div class="brand">AMA ‚Ä¢ GOONJ</div>
      <nav class="nav">
        <a href="/goonj" class="active">GOONJ</a>
        <a href="/about">About</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <h1>Generate Your GOONJ Certificate</h1>
      <p>Fill in the fields or upload a CSV. We'll place the details on the GOONJ template and download your certificate.</p>
      <div id="status" class="status muted">Checking template and email status‚Ä¶</div>
    </section>

    <section class="grid">
      <div class="card">
        <h2>Single Participant</h2>
        <form class="form" action="{{ url_for('goonj.generate_certificate') }}" method="post" onsubmit="handleFormSubmit(event, this)">
          <div class="field">
            <label for="name">Name<span class="req">*</span></label>
            <input id="name" name="name" type="text" required placeholder="Full name">
          </div>
          <div class="field">
            <label for="event">Event</label>
            <input id="event" name="event" type="text" value="GOONJ" placeholder="GOONJ">
          </div>
          <div class="field">
            <label for="organiser">Organised By</label>
            <input id="organiser" name="organiser" type="text" value="AMA" placeholder="AMA">
          </div>
          <div class="field">
            <label for="email">Email (optional)</label>
            <input id="email" name="email" type="email" placeholder="name@example.com">
            <small class="muted">If provided and SMTP is configured, certificate will be sent to this email.</small>
          </div>
          <div class="field">
            <label for="format">Format</label>
            <select id="format" name="format">
              <option value="png">PNG</option>
              <option value="pdf">PDF</option>
            </select>
          </div>
          <button class="btn primary" type="submit" id="submit-btn-1">Generate & Download</button>
        </form>
      </div>

      <div class="card">
        <h2>CSV Upload (first row)</h2>
        <form class="form" action="{{ url_for('goonj.generate_certificate') }}" method="post" enctype="multipart/form-data" onsubmit="handleFormSubmit(event, this)">
          <div class="field">
            <label for="file">CSV file</label>
            <input id="file" name="file" type="file" accept=".csv">
          </div>
          <div class="field">
            <label for="format2">Format</label>
            <select id="format2" name="format">
              <option value="png">PNG</option>
              <option value="pdf">PDF</option>
            </select>
          </div>
          <button class="btn" type="submit" id="submit-btn-2">Generate from CSV</button>
        </form>
        <p class="muted small">CSV headers supported: name, event, organiser (email optional for delivery). The first valid row will be used.</p>
      </div>
    </section>

    <section class="help card">
      <h2>How it works</h2>
      <ol>
        <li>Enter participant info or upload a CSV.</li>
        <li>We place it on the GOONJ certificate template.</li>
        <li>Your file downloads automatically. If email is provided and configured, a copy is sent too.</li>
      </ol>
    </section>
  </main>

  <footer class="site-footer">
    {% include 'partials/creator_card.html' %}
  </footer>

  <script>
  // Theme toggle functionality
  (function() {
    const themeToggle = document.getElementById('theme-toggle');
    const themeIcon = document.getElementById('theme-icon');
    const htmlElement = document.documentElement;
    
    // Check for saved theme preference or default to 'light'
    const currentTheme = localStorage.getItem('theme') || 'light';
    htmlElement.setAttribute('data-theme', currentTheme);
    themeIcon.textContent = currentTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    
    themeToggle.addEventListener('click', function() {
      const newTheme = htmlElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      htmlElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      themeIcon.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    });
  })();
  
  // Form submission with AJAX and status display
  const PROGRESS_UPDATE_INTERVAL = 1500; // milliseconds
  let currentSessionId = null;
  let progressPollingInterval = null;
  
  function handleFormSubmit(event, form) {
    event.preventDefault();
    
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    
    // Show loading state
    submitBtn.classList.add('loading');
    submitBtn.disabled = true;
    submitBtn.textContent = '‚è≥ Generating...';
    
    // Show status modal
    showStatusModal();
    updateStatus('Generating certificate and verifying alignment...', 'progress');
    
    // Generate a session ID for tracking (we'll get the real one from the server)
    currentSessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    // Start polling for alignment progress
    let attemptCount = 0;
    let maxAttempts = {{ email_max_retries }};
    
    progressPollingInterval = setInterval(() => {
      // Update UI with simulated progress (real progress would come from backend)
      attemptCount++;
      if (attemptCount <= maxAttempts) {
        updateStatus(`Verifying alignment... (attempt ${attemptCount}/${maxAttempts})`, 'progress');
        updateProgressDetails(attemptCount, maxAttempts);
      }
    }, PROGRESS_UPDATE_INTERVAL);
    
    // Prepare form data
    const formData = new FormData(form);
    formData.append('return_json', 'true');  // Request JSON response
    
    // Submit via fetch
    fetch(form.action, {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      clearInterval(progressPollingInterval);
      if (data.success) {
        handleSuccess(data);
      } else {
        handleError(data);
      }
    })
    .catch(error => {
      clearInterval(progressPollingInterval);
      handleError({ error: 'Network error', message: error.message });
    })
    .finally(() => {
      submitBtn.classList.remove('loading');
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
    });
  }
  
  function updateProgressDetails(attempt, maxAttempts) {
    const detailsEl = document.getElementById('status-details');
    if (detailsEl) {
      const percentage = Math.round((attempt / maxAttempts) * 100);
      detailsEl.innerHTML = `
        <div class="status-section">
          <h4>üîÑ Alignment Verification Progress</h4>
          <p><strong>Attempt:</strong> ${attempt} / ${maxAttempts}</p>
          <div style="background: #e0e0e0; border-radius: 4px; overflow: hidden; height: 20px; margin: 0.5rem 0;">
            <div style="background: #3498db; height: 100%; width: ${percentage}%; transition: width 0.3s;"></div>
          </div>
          <p style="font-size: 0.9em; color: #666;">Generating and verifying certificate alignment...</p>
        </div>
      `;
    }
  }
  
  function showStatusModal() {
    let modal = document.getElementById('status-modal');
    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'status-modal';
      modal.className = 'status-modal';
      modal.innerHTML = `
        <div class="status-modal-content">
          <div class="status-modal-header">
            <h3>Certificate Generation Status</h3>
            <button class="close-btn" onclick="closeStatusModal()">&times;</button>
          </div>
          <div class="status-modal-body">
            <div id="status-message" class="status-message"></div>
            <div id="status-details" class="status-details"></div>
            <div id="status-actions" class="status-actions"></div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }
    modal.style.display = 'flex';
  }
  
  function closeStatusModal() {
    const modal = document.getElementById('status-modal');
    if (modal) {
      modal.style.display = 'none';
    }
  }
  
  function updateStatus(message, type) {
    const messageEl = document.getElementById('status-message');
    if (messageEl) {
      messageEl.textContent = message;
      messageEl.className = 'status-message ' + type;
    }
  }
  
  function handleSuccess(data) {
    updateStatus('‚úÖ Certificate generated successfully!', 'success');
    
    const detailsEl = document.getElementById('status-details');
    const actionsEl = document.getElementById('status-actions');
    
    let details = `
      <div class="status-section">
        <h4>üìú Certificate Details</h4>
        <p><strong>Participant:</strong> ${data.participant.name}</p>
        <p><strong>Event:</strong> ${data.participant.event}</p>
        <p><strong>Organisation:</strong> ${data.participant.organiser}</p>
        <p><strong>Format:</strong> ${data.certificate.format.toUpperCase()}</p>
        <p><strong>Size:</strong> ${(data.certificate.size_bytes / 1024).toFixed(1)} KB</p>
      </div>
    `;
    
    // Alignment status
    if (data.alignment_status) {
      details += `
        <div class="status-section">
          <h4>üéØ Alignment Verification</h4>
          <p><strong>Status:</strong> ${data.alignment_status.passed ? '‚úÖ Passed' : (data.alignment_status.used_best_available ? '‚ö†Ô∏è Used Best Available' : '‚ùå Failed')}</p>
          <p>${data.alignment_status.message}</p>
      `;
      
      // Show attempts if available (for retry-based verification)
      if (data.alignment_status.attempts !== undefined) {
        const maxAttempts = data.alignment_status.max_attempts || 100;
        details += `<p><strong>Attempts:</strong> ${data.alignment_status.attempts}/${maxAttempts}</p>`;
        
        // If max attempts reached but used best available
        if (data.alignment_status.used_best_available) {
          details += `<p style="color: #ff9800;"><strong>Note:</strong> Maximum attempts reached. Using certificate with best alignment (closest match to reference).</p>`;
          
          if (data.alignment_status.best_attempt) {
            details += `<p><strong>Best Attempt:</strong> #${data.alignment_status.best_attempt.attempt_number} with ${data.alignment_status.best_attempt.max_difference_px.toFixed(4)} px difference</p>`;
          }
        }
      } else if (data.alignment_status.passed) {
        // If no attempts field, it passed on first try
        details += `<p><strong>Attempts:</strong> 1/1 (Passed on first verification)</p>`;
      }
      
      // Show max difference if available
      if (data.alignment_status.max_difference_px !== undefined) {
        const maxDiff = data.alignment_status.max_difference_px;
        const tolerance = data.alignment_status.tolerance_px || 0.02;
        details += `<p><strong>Max Difference:</strong> ${maxDiff.toFixed(4)} px (tolerance: ${tolerance} px)</p>`;
      }
      
      // Show field position details if available
      if (data.alignment_status.field_positions) {
        const fp = data.alignment_status.field_positions;
        details += `
          <div class="field-positions">
            <p><strong>Field Position Accuracy:</strong></p>
            <ul style="margin: 0.5em 0; padding-left: 1.5em;">
        `;
        
        for (const [fieldName, fieldData] of Object.entries(fp)) {
          if (fieldData && typeof fieldData === 'object') {
            const yDiff = fieldData.y_diff !== undefined ? fieldData.y_diff.toFixed(4) : '?';
            const xDiff = fieldData.x_diff !== undefined ? fieldData.x_diff.toFixed(4) : '?';
            const color = '#10b981'; // Green for now, will be calculated based on tolerance in future
            details += `<li style="color: ${color};">‚úì ${fieldName}: Y=${yDiff}px, X=${xDiff}px</li>`;
          }
        }
        
        details += `
            </ul>
          </div>
        `;
      }
      
      details += '</div>';
    }
    
    // Email status
    if (data.email_status.attempted) {
      details += `
        <div class="status-section">
          <h4>üìß Email Delivery</h4>
      `;
      
      if (data.email_status.sent) {
        details += `
          <p><strong>Status:</strong> ‚úÖ Sent successfully</p>
          <p><strong>Recipient:</strong> ${data.participant.email}</p>
        `;
        // Show attempts if available
        if (data.email_status.attempts !== undefined) {
          details += `<p><strong>Delivery attempts:</strong> ${data.email_status.attempts}/{{ email_max_retries }}</p>`;
        }
      } else if (data.email_status.smtp_config && !data.email_status.smtp_config.configured) {
        details += `
          <p><strong>Status:</strong> ‚ö†Ô∏è Not sent - SMTP not configured</p>
          <div class="error-details">
            <p><strong>Issue:</strong> ${data.email_status.smtp_config.message}</p>
            <p><strong>Missing configuration:</strong></p>
            <ul>
              ${data.email_status.smtp_config.issues.map(issue => `<li>${issue}</li>`).join('')}
            </ul>
            <p class="help-text">To enable email sending, configure these settings in your .env file.</p>
          </div>
        `;
      } else {
        details += `
          <p><strong>Status:</strong> ‚ùå Failed to send</p>
        `;
        // Show attempts if available
        if (data.email_status.attempts !== undefined) {
          details += `<p><strong>Failed after:</strong> ${data.email_status.attempts}/{{ email_max_retries }} attempts</p>`;
        }
        details += `<p><strong>Error:</strong> ${data.email_status.error || 'Unknown error'}</p>`;
      }
      
      details += '</div>';
    }
    
    detailsEl.innerHTML = details;
    
    // Action buttons
    actionsEl.innerHTML = `
      <button class="btn primary" onclick="downloadCertificate('${data.certificate.download_url}', '${data.certificate.filename}')">
        üì• Download Certificate
      </button>
      <button class="btn" onclick="viewCertificate('${data.certificate.download_url}')">
        üëÅÔ∏è View Certificate
      </button>
      <button class="btn" onclick="closeStatusModal()">Close</button>
    `;
  }
  
  function handleError(data) {
    updateStatus('‚ùå Certificate generation failed', 'error');
    
    const detailsEl = document.getElementById('status-details');
    const actionsEl = document.getElementById('status-actions');
    
    let details = `
      <div class="status-section error-section">
        <h4>Error Details</h4>
        <p><strong>Error:</strong> ${data.error || 'Unknown error'}</p>
        <p>${data.message || ''}</p>
    `;
    
    if (data.alignment_status && !data.alignment_status.passed) {
      details += `
        <h4>Alignment Issues</h4>
        <p>${data.alignment_status.message}</p>
      `;
    }
    
    details += '</div>';
    detailsEl.innerHTML = details;
    
    actionsEl.innerHTML = '<button class="btn" onclick="closeStatusModal()">Close</button>';
  }
  
  function downloadCertificate(url, filename) {
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }
  
  function viewCertificate(url) {
    window.open(url, '_blank');
  }
  
  // Status check - Use detailed system status endpoint
  fetch("{{ url_for('goonj.system_status') }}")
    .then(r => r.json())
    .then(data => {
      const el = document.getElementById('status');
      const tpl = data.template_exists ? '‚úì Template Ready' : '‚úó Template Missing';
      
      // Show detailed SMTP status with reasons
      let smtp = '';
      if (data.smtp_configured) {
        smtp = '‚úì Email Configured';
      } else {
        // Show why SMTP is disabled
        if (data.smtp_status_details && data.smtp_status_details.issues && data.smtp_status_details.issues.length > 0) {
          const firstIssue = data.smtp_status_details.issues[0];
          smtp = `‚ö† Email Disabled: ${firstIssue}`;
        } else {
          smtp = '‚ö† Email Not Configured';
        }
      }
      
      el.textContent = `${tpl} ‚Ä¢ ${smtp}`;
      el.classList.remove('muted');
      
      // Add status color class
      el.classList.remove('status-success', 'status-error', 'status-warning');
      if (data.template_exists && data.smtp_configured) {
        el.classList.add('status-success');
      } else if (!data.template_exists) {
        el.classList.add('status-error');
      } else {
        el.classList.add('status-warning');
      }
      
      // Set tooltip with full details if SMTP is not configured
      if (!data.smtp_configured && data.smtp_status_details) {
        el.title = data.smtp_status_details.message || 'SMTP not configured';
      }
    })
    .catch(() => {
      const el = document.getElementById('status');
      el.textContent = 'Status unavailable';
      el.classList.add('muted');
    });
  </script>
  
  <!-- System Status Widget -->
  <script src="{{ url_for('static', filename='js/system_status.js') }}"></script>
</body>
</html>
