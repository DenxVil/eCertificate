{% extends "base.html" %}

{% block title %}Smart Certificate Generator - Goonj{% endblock %}

{% block extra_css %}
<style>
    .hero-section {
        text-align: center;
        padding: 3rem 0;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
        border-radius: 20px;
        margin-bottom: 3rem;
    }
    
    .hero-title {
        font-size: 3.5rem;
        margin-bottom: 1rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .hero-subtitle {
        font-size: 1.3rem;
        color: #666;
        margin-bottom: 2rem;
        line-height: 1.6;
    }
    
    .workflow-steps {
        display: flex;
        justify-content: space-between;
        margin: 3rem 0;
        padding: 1.5rem;
        background: #f8f9fa;
        border-radius: 15px;
    }
    
    .step {
        flex: 1;
        text-align: center;
        padding: 1rem;
        position: relative;
    }
    
    .step::after {
        content: '‚Üí';
        position: absolute;
        right: -15px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 1.5rem;
        color: #667eea;
    }
    
    .step:last-child::after {
        content: '';
    }
    
    .step.active {
        background: #667eea;
        color: white;
        border-radius: 10px;
    }
    
    .step.completed {
        background: #28a745;
        color: white;
        border-radius: 10px;
    }
    
    .upload-area {
        border: 3px dashed #667eea;
        border-radius: 15px;
        padding: 4rem 2rem;
        text-align: center;
        background: #f8f9fa;
        cursor: pointer;
        transition: all 0.3s;
        margin: 2rem 0;
    }
    
    .upload-area:hover {
        background: #e9ecef;
        border-color: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
    }
    
    .upload-area.dragover {
        background: #d4edda;
        border-color: #28a745;
    }
    
    .field-card {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        transition: all 0.3s;
    }
    
    .field-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        transform: translateY(-2px);
    }
    
    .field-label {
        font-weight: bold;
        color: #667eea;
        margin-bottom: 0.5rem;
        font-size: 1.1rem;
    }
    
    .field-details {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 1rem;
    }
    
    .preview-image {
        max-width: 100%;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        margin-top: 1.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(102, 126, 234, 0.3);
        border-radius: 50%;
        border-top-color: #667eea;
        animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .success-box {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        border: 2px solid #28a745;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        text-align: center;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px 30px;
        font-size: 1.1rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: bold;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .features-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 2rem;
        margin: 3rem 0;
    }
    
    .feature-card {
        text-align: center;
        padding: 2rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        transition: all 0.3s;
    }
    
    .feature-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    }
    
    .feature-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="hero-section">
    <h1 class="hero-title">üéØ Smart Certificate Generator</h1>
    <p class="hero-subtitle">
        Upload your certificate template, let AI detect the fields,<br>
        and generate perfectly aligned certificates in seconds!
    </p>
</div>

<!-- Workflow Steps -->
<div class="workflow-steps">
    <div class="step" id="step1">
        <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üìÑ</div>
        <div style="font-weight: bold;">Upload Template</div>
    </div>
    <div class="step" id="step2">
        <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üîç</div>
        <div style="font-weight: bold;">AI Scans</div>
    </div>
    <div class="step" id="step3">
        <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">‚úèÔ∏è</div>
        <div style="font-weight: bold;">Enter Values</div>
    </div>
    <div class="step" id="step4">
        <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">‚úÖ</div>
        <div style="font-weight: bold;">Download</div>
    </div>
</div>

<!-- Step 1: Upload Template -->
<div id="upload-section">
    <form id="uploadForm" enctype="multipart/form-data">
        <div class="upload-area" id="uploadArea">
            <div style="font-size: 4rem; margin-bottom: 1rem;">üì§</div>
            <h2 style="color: #667eea; margin-bottom: 0.5rem;">Upload Your Certificate Template</h2>
            <p style="color: #666; margin: 1rem 0; font-size: 1.1rem;">
                Drag & drop your file here or click to browse
            </p>
            <input type="file" id="templateFile" name="template" accept="image/png,image/jpeg,image/jpg,application/pdf" style="display: none;">
            <button type="button" class="btn btn-primary" onclick="document.getElementById('templateFile').click()">
                Choose File
            </button>
            <p style="font-size: 0.95rem; color: #999; margin-top: 1.5rem;">
                Supported formats: PNG, JPG, PDF ‚Ä¢ Max size: 16MB
            </p>
        </div>
    </form>
</div>

<!-- Step 2: Scanning Results -->
<div id="scanning-section" style="display: none;">
    <h2 style="color: #667eea; margin-bottom: 1rem;">üîç Analyzing Your Template...</h2>
    <div style="text-align: center; padding: 4rem 2rem; background: #f8f9fa; border-radius: 15px;">
        <div class="loading" style="width: 60px; height: 60px; border-width: 5px;"></div>
        <p style="margin-top: 2rem; color: #666; font-size: 1.1rem;">
            Our AI is detecting text fields in your template...<br>
            <small style="color: #999;">This usually takes a few seconds</small>
        </p>
    </div>
</div>

<!-- Step 3: Fields Detected -->
<div id="fields-section" style="display: none;">
    <h2 style="color: #667eea; margin-bottom: 1rem;">‚úèÔ∏è Enter Values for Detected Fields</h2>
    <p style="color: #666; margin-bottom: 2rem; font-size: 1.05rem;">
        We found the following fields in your certificate. Please enter the values you want:
    </p>
    
    <div id="detectedFields">
        <!-- Fields will be dynamically added here -->
    </div>
    
    <div style="margin-top: 2.5rem; text-align: center;">
        <button type="button" class="btn btn-primary" id="generateBtn" style="font-size: 1.2rem; padding: 15px 40px;">
            Generate Certificate ‚ú®
        </button>
    </div>
</div>

<!-- Step 4: Generated Certificate -->
<div id="result-section" style="display: none;">
    <div class="success-box">
        <h2 style="color: #28a745; margin-bottom: 0.5rem;">‚úÖ Certificate Generated Successfully!</h2>
        <p style="color: #155724; margin: 0; font-size: 1.1rem;">Your perfectly aligned certificate is ready to download</p>
    </div>
    
    <div id="certificatePreview" style="text-align: center;">
        <!-- Certificate preview will be shown here -->
    </div>
    
    <div style="margin-top: 2rem; text-align: center;">
        <button type="button" class="btn btn-primary" id="downloadBtn" style="margin-right: 1rem;">
            üì• Download Certificate
        </button>
        <button type="button" class="btn btn-secondary" onclick="location.reload()">
            üîÑ Generate Another
        </button>
    </div>
</div>

<!-- Features Section -->
<div class="features-grid" style="margin-top: 4rem;">
    <div class="feature-card">
        <div class="feature-icon">ü§ñ</div>
        <h3 style="color: #667eea; margin-bottom: 0.5rem;">AI-Powered</h3>
        <p style="color: #666; font-size: 0.95rem;">Automatic field detection using advanced OCR technology</p>
    </div>
    <div class="feature-card">
        <div class="feature-icon">‚ö°</div>
        <h3 style="color: #667eea; margin-bottom: 0.5rem;">Lightning Fast</h3>
        <p style="color: #666; font-size: 0.95rem;">Generate certificates in seconds, not minutes</p>
    </div>
    <div class="feature-card">
        <div class="feature-icon">üé®</div>
        <h3 style="color: #667eea; margin-bottom: 0.5rem;">Perfect Alignment</h3>
        <p style="color: #666; font-size: 0.95rem;">AI ensures text is perfectly positioned every time</p>
    </div>
    <div class="feature-card">
        <div class="feature-icon">üìÑ</div>
        <h3 style="color: #667eea; margin-bottom: 0.5rem;">Any Template</h3>
        <p style="color: #666; font-size: 0.95rem;">Works with PNG, JPG, and PDF templates</p>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let scannedData = null;
let fieldValues = {};

// Upload area drag and drop
const uploadArea = document.getElementById('uploadArea');
const templateFile = document.getElementById('templateFile');

uploadArea.addEventListener('click', (e) => {
    if (e.target !== uploadArea && e.target.parentElement !== uploadArea) return;
    templateFile.click();
});

uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        templateFile.files = files;
        handleFileUpload(files[0]);
    }
});

templateFile.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleFileUpload(e.target.files[0]);
    }
});

function handleFileUpload(file) {
    // Show scanning section
    setStep(2);
    document.getElementById('upload-section').style.display = 'none';
    document.getElementById('scanning-section').style.display = 'block';
    
    // Create form data
    const formData = new FormData();
    formData.append('template', file);
    
    // Upload and scan
    fetch('/smart-certificate/scan', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.error || 'Server error');
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            scannedData = data;
            displayDetectedFields(data.fields);
        } else {
            alert('Error scanning template: ' + (data.error || 'Unknown error'));
            location.reload();
        }
    })
    .catch(error => {
        alert('Error uploading template: ' + error.message);
        location.reload();
    });
}

function displayDetectedFields(fields) {
    setStep(3);
    document.getElementById('scanning-section').style.display = 'none';
    document.getElementById('fields-section').style.display = 'block';
    
    const container = document.getElementById('detectedFields');
    container.innerHTML = '';
    
    if (!fields || fields.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 3rem; background: #fff3cd; border-radius: 12px; border: 2px solid #ffc107;">
                <p style="color: #856404; font-size: 1.1rem; margin: 0;">
                    ‚ö†Ô∏è No fields detected in your template.<br>
                    <small>The template may not have editable text fields or they couldn't be detected.</small>
                </p>
            </div>
        `;
        return;
    }
    
    fields.forEach((field, index) => {
        const fieldCard = document.createElement('div');
        fieldCard.className = 'field-card';
        fieldCard.innerHTML = `
            <div class="field-label">üìù Field ${index + 1}: "${field.text}"</div>
            <div class="field-details">
                üìç Position: (${(field.x * 100).toFixed(1)}%, ${(field.y * 100).toFixed(1)}%) | 
                üî§ Font Size: ${field.font_size}px | 
                ‚ÜîÔ∏è Alignment: ${field.alignment} |
                üè∑Ô∏è Type: ${field.field_type}
            </div>
            <div style="margin-top: 1rem;">
                <label for="field_${index}" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
                    Enter value for this field:
                </label>
                <input type="text" 
                       id="field_${index}" 
                       data-field-text="${field.text}"
                       placeholder="Enter ${field.text}" 
                       style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem; transition: all 0.3s;"
                       onfocus="this.style.borderColor='#667eea'"
                       onblur="this.style.borderColor='#e0e0e0'">
            </div>
        `;
        container.appendChild(fieldCard);
    });
}

document.getElementById('generateBtn').addEventListener('click', () => {
    // Collect field values
    const fields = scannedData.fields;
    fieldValues = {};
    
    fields.forEach((field, index) => {
        const input = document.getElementById(`field_${index}`);
        if (input) {
            fieldValues[field.text] = input.value || field.text;
        }
    });
    
    // Show loading state
    const generateBtn = document.getElementById('generateBtn');
    const originalBtnText = generateBtn.innerHTML;
    generateBtn.disabled = true;
    generateBtn.innerHTML = '<span class="loading" style="margin-right: 10px;"></span> Generating Your Certificate...';
    
    // Generate certificate
    fetch('/smart-certificate/generate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            template_path: scannedData.template_path,
            fields: fieldValues
        })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.error || 'Server error');
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            setStep(4);
            document.getElementById('fields-section').style.display = 'none';
            document.getElementById('result-section').style.display = 'block';
            displayGeneratedCertificate(data);
        } else {
            throw new Error(data.error || 'Unknown error');
        }
    })
    .catch(error => {
        alert('Error generating certificate: ' + error.message);
        generateBtn.disabled = false;
        generateBtn.innerHTML = originalBtnText;
    });
});

function displayGeneratedCertificate(data) {
    const preview = document.getElementById('certificatePreview');
    preview.innerHTML = `
        <img src="/${data.certificate_path}" class="preview-image" alt="Generated Certificate">
    `;
    
    document.getElementById('downloadBtn').onclick = () => {
        window.location.href = '/smart-certificate/download?path=' + encodeURIComponent(data.certificate_path);
    };
}

function setStep(stepNumber) {
    // Update step indicators
    for (let i = 1; i <= 4; i++) {
        const step = document.getElementById(`step${i}`);
        step.classList.remove('active', 'completed');
        if (i < stepNumber) {
            step.classList.add('completed');
        } else if (i === stepNumber) {
            step.classList.add('active');
        }
    }
}

// Initialize
setStep(1);
</script>
{% endblock %}
