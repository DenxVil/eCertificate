{% extends "base.html" %}

{% block content %}
<div style="margin-bottom: 2rem;">
    <a href="/jobs/" class="btn btn-secondary">← Back to Jobs</a>
</div>

<h1>Job #{{ job.id }} - {{ job.event.name }}</h1>

<div style="margin-top: 2rem;">
    <h3>Job Details</h3>
    <table style="width: auto;">
        <tr>
            <th style="width: 200px;">Job ID</th>
            <td>{{ job.id }}</td>
        </tr>
        <tr>
            <th>Event</th>
            <td>{{ job.event.name }}</td>
        </tr>
        <tr>
            <th>Status</th>
            <td>
                <span style="padding: 5px 10px; border-radius: 5px; 
                    {% if job.status == 'completed' %}background: #d4edda; color: #155724;
                    {% elif job.status == 'processing' %}background: #fff3cd; color: #856404;
                    {% elif job.status == 'failed' %}background: #f8d7da; color: #721c24;
                    {% else %}background: #d1ecf1; color: #0c5460;{% endif %}">
                    {{ job.status.upper() }}
                </span>
            </td>
        </tr>
        <tr>
            <th>Total Certificates</th>
            <td>{{ job.total_certificates }}</td>
        </tr>
        <tr>
            <th>Generated</th>
            <td>{{ job.generated_certificates }}</td>
        </tr>
        <tr>
            <th>Progress</th>
            <td>
                <div style="width: 300px; height: 20px; background: #e0e0e0; border-radius: 10px; overflow: hidden;">
                    <div style="width: {{ (job.generated_certificates / job.total_certificates * 100) if job.total_certificates > 0 else 0 }}%; 
                                height: 100%; background: #667eea;"></div>
                </div>
                <small>{{ "%.1f" | format((job.generated_certificates / job.total_certificates * 100) if job.total_certificates > 0 else 0) }}%</small>
            </td>
        </tr>
        <tr>
            <th>Created At</th>
            <td>{{ job.created_at.strftime('%Y-%m-%d %H:%M:%S') if job.created_at else 'N/A' }}</td>
        </tr>
        <tr>
            <th>Completed At</th>
            <td>{{ job.completed_at.strftime('%Y-%m-%d %H:%M:%S') if job.completed_at else 'In progress...' }}</td>
        </tr>
        {% if job.error_message %}
        <tr>
            <th>Error</th>
            <td style="color: #e74c3c;">{{ job.error_message }}</td>
        </tr>
        {% endif %}
    </table>
</div>

{% if job.status == 'processing' %}
<div style="margin-top: 2rem; padding: 1rem; background: #fff3cd; border-radius: 5px;">
    <strong>Job is currently processing...</strong> Refresh this page to see updated progress.
    <button onclick="location.reload()" class="btn" style="margin-left: 1rem;">Refresh</button>
</div>
{% endif %}

<div style="margin-top: 3rem;">
    <h3>Participants ({{ participants|length }})</h3>
    {% if participants %}
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Certificate</th>
                    <th>Email Sent</th>
                </tr>
            </thead>
            <tbody>
                {% for participant in participants %}
                <tr>
                    <td>{{ participant.name }}</td>
                    <td>{{ participant.email }}</td>
                    <td>{{ '✅' if participant.certificate_path else '⏳' }}</td>
                    <td>{{ '✅' if participant.email_sent else '❌' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p style="color: #666;">No participants found for this job.</p>
    {% endif %}
</div>

{% if job.status == 'processing' %}
<script>
    // Auto-refresh every 5 seconds while job is processing
    setTimeout(function() {
        location.reload();
    }, 5000);
</script>
{% endif %}
{% endblock %}
